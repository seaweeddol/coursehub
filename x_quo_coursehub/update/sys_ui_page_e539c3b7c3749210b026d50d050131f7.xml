<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ui_page">
    <sys_ui_page action="INSERT_OR_UPDATE">
        <category>general</category>
        <client_script><![CDATA[var currentUser;
var currentUserText = document.getElementById("currentLearnerText");

function setCurrentUser() {
    var selection = document.getElementById("learners");
    var user = selection.options[selection.selectedIndex].value;
    currentUser = user;
	currentUserText.innerHTML = "Current learner: " + currentUser;
}

function populateLearnerOptions() {
    var requestBody = "";
    var parsedResponse;

    var client = new XMLHttpRequest();
    client.open("get", "https://dev201115.service-now.com/api/now/table/x_quo_coursehub_learner?sysparm_fields=sys_id%2Cuser_account");

    client.setRequestHeader('Accept', 'application/json');
    client.setRequestHeader('Content-Type', 'application/json');

    //Eg. UserName="admin", Password="admin" for this code sample.
    client.setRequestHeader('Authorization', 'Basic ' + btoa('admin' + ':' + 'mE7QuyPj3=K!'));

    client.onreadystatechange = function() {
        if (this.readyState == this.DONE) {
            parsedResponse = JSON.parse(this.response)["result"];
            var learners = document.getElementById("learners");

            for (const learner of parsedResponse) {
                console.log(learner);
                var option = document.createElement('option');
                option.text = option.value = learner.sys_id;
                learners.add(option, 0);
                setCurrentUser();
            }

            // TODO: debug why option.text is set before getLearnerName() finishes getting response
            // var learnerOptions = document.getElementById("learners").options;
            // var length = learnerOptions.length;
            // console.log(length);
            // for (let index = 0; index <= length; index++) {
            //     console.log(learnerOptions[index].text);
            //     var learnerName = getLearnerName(learnerOptions[index].value);
            //     console.log("learnerName = " + learnerName);

            //     option.text = learnerName;
            //     console.log("option.text = " + option.text);
            // }
        }
    };
    client.send(requestBody);
}

// TODO: update dropdown learner IDs to names
function getLearnerName(userAccountValue) {
    var requestBody = "";
    var name;

    var client = new XMLHttpRequest();

    client.open("get", `https://dev201115.service-now.com/api/now/table/sys_user?sysparm_fields=name&sys_id=${userAccountValue}`);

    client.setRequestHeader('Accept', 'application/json');
    client.setRequestHeader('Content-Type', 'application/json');

    //Eg. UserName="admin", Password="admin" for this code sample.
    client.setRequestHeader('Authorization', 'Basic ' + btoa('admin' + ':' + 'mE7QuyPj3=K!'));

    client.onreadystatechange = function() {
        if (this.readyState == this.DONE) {
            name = JSON.parse(this.response)["result"][0].name;
            console.log(name)
            return name;
        }
    };
    client.send(requestBody);
}

function displayCourseDetails(data) {
    var table = document.getElementById("course-list-table");
    var row = table.insertRow();

    row.insertCell().innerHTML = data.title;
    row.insertCell().innerHTML = data.description;
    row.insertCell().innerHTML = data.duration;

    const button = document.createElement('button');
    button.innerText = 'Subscribe';
    button.addEventListener('click', () => {
        console.log("learner: " + currentUser);
        console.log("course: " + data.sys_id);
        subscribeToCourse(currentUser, data.sys_id);
    });
    row.insertCell().appendChild(button);
}

function subscribeToCourse(learner, course) {
    if (currentUser != null) {
        console.log("learner: " + learner);
        console.log("course: " + course);

        var requestBody = "{\"learner\":\"" + learner + "\",\"course\":\"" + course + "\"}";
        console.log(requestBody);

        var client = new XMLHttpRequest();
        client.open("post", "https://dev201115.service-now.com/api/now/table/x_quo_coursehub_course_subscription");

        client.setRequestHeader('Accept', 'application/json');
        client.setRequestHeader('Content-Type', 'application/json');

        //Eg. UserName="admin", Password="admin" for this code sample.
        client.setRequestHeader('Authorization', 'Basic ' + btoa('admin' + ':' + 'mE7QuyPj3=K!'));

        client.onreadystatechange = function() {
            if (this.readyState == this.DONE) {
                console.log(this.response);
            }
        };
        client.send(requestBody);
    }
}

// TODO parse course duration
// TODO encrypt/obscure authorization

var requestBody = "";
var parsedResponse;

var client = new XMLHttpRequest();
client.open("get", "https://dev201115.service-now.com/api/now/table/x_quo_coursehub_course?sysparm_fields=duration%2Ctitle%2Cdescription%sys_id");

client.setRequestHeader('Accept', 'application/json');
client.setRequestHeader('Content-Type', 'application/json');

//Eg. UserName="admin", Password="admin" for this code sample.
client.setRequestHeader('Authorization', 'Basic ' + btoa('admin' + ':' + 'mE7QuyPj3=K!'));

client.onreadystatechange = function() {
    if (this.readyState == this.DONE) {
        parsedResponse = JSON.parse(this.response)["result"];
        for (const course of parsedResponse) {
            displayCourseDetails(course);
        }
    }
};

client.send(requestBody);

populateLearnerOptions();]]></client_script>
        <description/>
        <direct>false</direct>
        <endpoint>x_quo_coursehub_course-list.do</endpoint>
        <html><![CDATA[<?xml version="1.0" encoding="utf-8" ?>
<j:jelly trim="false" xmlns:j="jelly:core" xmlns:g="glide" xmlns:j2="null" xmlns:g2="null">
    <style>
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td,
        th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }
    </style>

    <body>
        <div id="currentLearnerText"></div>

        <label for="learners">Select Learner: </label>

        <select name="learners" id="learners">
        </select>

        <button type="button" onclick="setCurrentUser()">Set Current Learner</button>

        <button type="button" onclick="setCurrentUser()">View My Courses</button>

        <table id="course-list-table">
            <tr>
                <th>Course Title</th>
                <th>Course Description</th>
                <th>Course Duration</th>
                <th>Subscribe to Course</th>
            </tr>
        </table>
        <header>

        </header>

        <section>

        </section>

        <script>

        </script>
    </body>
</j:jelly>]]></html>
        <name>course-list</name>
        <processing_script/>
        <sys_class_name>sys_ui_page</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-29 13:46:03</sys_created_on>
        <sys_id>e539c3b7c3749210b026d50d050131f7</sys_id>
        <sys_mod_count>125</sys_mod_count>
        <sys_name>course-list</sys_name>
        <sys_package display_value="CourseHub" source="x_quo_coursehub">d7affc501bf0ded0afce657a234bcb67</sys_package>
        <sys_policy/>
        <sys_scope display_value="CourseHub">d7affc501bf0ded0afce657a234bcb67</sys_scope>
        <sys_update_name>sys_ui_page_e539c3b7c3749210b026d50d050131f7</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-30 09:51:28</sys_updated_on>
    </sys_ui_page>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>e539c3b7c3749210b026d50d050131f7</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-29 13:46:02</sys_created_on>
        <sys_id>451a47f7c3749210b026d50d050131e5</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-29 13:46:02</sys_updated_on>
        <table>sys_ui_page</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
